{% extends "base.twig" %}
{% block title %}Tickets — TicketApp{% endblock %}
{% block content %}
<h2>Tickets</h2>

<form method="post" class="card" style="margin:16px 0;display:grid;gap:12px" aria-label="Create ticket" action="/tickets">
  <input type="hidden" name="action" value="create"/>
  <div>
    <label class="label" for="title">Title *</label>
    <input id="title" class="input" name="title" placeholder="Short summary" required aria-invalid="{{ error is defined and error ? 'true':'false' }}"/>
    <div class="label" aria-hidden>1–120 chars</div>
  </div>
  <div>
    <label class="label" for="status">Status *</label>
    <select id="status" class="input" name="status" required>
      <option value="open">open</option>
      <option value="in_progress">in_progress</option>
      <option value="closed">closed</option>
    </select>
  </div>
  <div>
    <label class="label" for="desc">Description</label>
    <textarea id="desc" class="input" rows="4" name="description" aria-describedby="desc-help"></textarea>
    <div id="desc-help" class="label" aria-hidden>Optional ≤ 2000 chars</div>
  </div>
  {% if error is defined and error %}<div class="error" role="alert">{{ error }}</div>{% endif %}
  <div><button class="btn" type="submit">Create</button></div>
</form>

<div class="grid" style="gap:16px" role="list" aria-label="Ticket list">
  {% for t in tickets|default([]) | sort((a,b) => b.createdAt <=> a.createdAt) %}
    <div class="card" role="listitem" aria-label="Ticket {{ t.title }}">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3 style="margin:0">{{ t.title }}</h3>
        <span class="status {{ t.status }}">{{ t.status }}</span>
      </div>
      {% if t.description %}<p style="margin:0;color:var(--muted)">{{ t.description }}</p>{% endif %}
      <small style="color:var(--muted)">Created {{ t.createdAt|date("Y-m-d H:i") }} • Updated {{ t.updatedAt|date("Y-m-d H:i") }}</small>

      <details style="margin-top:8px">
        <summary>Edit</summary>
        <form method="post" class="grid" style="gap:10px;margin-top:8px" action="/tickets">
          <input type="hidden" name="action" value="update"/>
          <input type="hidden" name="id" value="{{ t.id }}"/>
          <input class="input" name="title" value="{{ t.title }}" aria-label="Title"/>
          <select class="input" name="status" aria-label="Status">
            <option value="open" {{ t.status=='open'?'selected':'' }}>open</option>
            <option value="in_progress" {{ t.status=='in_progress'?'selected':'' }}>in_progress</option>
            <option value="closed" {{ t.status=='closed'?'selected':'' }}>closed</option>
          </select>
          <textarea class="input" rows="3" name="description" aria-label="Description">{{ t.description }}</textarea>
          <div style="display:flex;gap:8px">
            <button class="btn" type="submit">Save</button>
          </div>
        </form>
      </details>

      <form method="post" action="/tickets" style="margin-top:8px" onsubmit="return confirm('Delete this ticket?')">
        <input type="hidden" name="action" value="delete"/>
        <input type="hidden" name="id" value="{{ t.id }}"/>
        <button class="btn ghost" type="submit">Delete</button>
      </form>
    </div>
  {% else %}
    <div class="card">No tickets yet.</div>
  {% endfor %}
</div>
{% if flash is defined and flash %}<div class="toast" role="status">{{ flash }}</div>{% endif %}
{% endblock %}
